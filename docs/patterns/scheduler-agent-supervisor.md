---
title: Scheduler-Agent-Supervisor
description: Koordinieren Sie eine Reihe von Aktionen in einer verteilten Gruppe von Diensten und anderen Remoteressourcen.
keywords: Entwurfsmuster
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- messaging
- resiliency
ms.openlocfilehash: 03bfe2fe96b3b81d547cfedb075bcf855846b668
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 11/14/2017
---
# <a name="scheduler-agent-supervisor-pattern"></a><span data-ttu-id="9fdb8-104">Muster „Scheduler-Agent-Supervisor“</span><span class="sxs-lookup"><span data-stu-id="9fdb8-104">Scheduler Agent Supervisor pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="9fdb8-105">Koordinieren Sie eine Reihe von verteilten Aktionen als einen einzelnen Vorgang.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-105">Coordinate a set of distributed actions as a single operation.</span></span> <span data-ttu-id="9fdb8-106">Wenn eine der Aktionen nicht erfolgreich ist, versuchen Sie, die Fehler transparent zu behandeln, oder machen Sie andernfalls die ausgeführte Arbeit rückgängig, damit der Vorgang als Ganzes erfolgreich ist oder zu einem Fehler führt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-106">If any of the actions fail, try to handle the failures transparently, or else undo the work that was performed, so the entire operation succeeds or fails as a whole.</span></span> <span data-ttu-id="9fdb8-107">Dies kann zur Resilienz eines verteilten Systems beitragen, indem das Wiederherstellen und Wiederholen von Aktionen ermöglicht wird, die aufgrund von vorübergehenden Ausnahmen, langfristigen Fehlern und Prozessausfällen zu einem Fehler führen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-107">This can add resiliency to a distributed system, by enabling it to recover and retry actions that fail due to transient exceptions, long-lasting faults, and process failures.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="9fdb8-108">Kontext und Problem</span><span class="sxs-lookup"><span data-stu-id="9fdb8-108">Context and problem</span></span>

<span data-ttu-id="9fdb8-109">Eine Anwendung führt Tasks aus, die eine Reihe von Schritten umfassen, von denen einige möglicherweise Remotedienste aufrufen oder auf Remoteressourcen zugreifen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-109">An application performs tasks that include a number of steps, some of which might invoke remote services or access remote resources.</span></span> <span data-ttu-id="9fdb8-110">Die einzelnen Schritte können voneinander unabhängig sein, aber sie werden von der Anwendungslogik orchestriert, die den Task implementiert.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-110">The individual steps might be independent of each other, but they are orchestrated by the application logic that implements the task.</span></span>

<span data-ttu-id="9fdb8-111">Wann immer dies möglich ist, sollte die Anwendung sicherstellen, dass der Task bis zum Abschluss ausgeführt wird, und alle Fehler beheben, die beim Zugriff auf Remotedienste oder Ressourcen auftreten können.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-111">Whenever possible, the application should ensure that the task runs to completion and resolve any failures that might occur when accessing remote services or resources.</span></span> <span data-ttu-id="9fdb8-112">Fehler können verschiedenste Ursachen haben.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-112">Failures can occur for many reasons.</span></span> <span data-ttu-id="9fdb8-113">Beispielsweise kann das Netzwerk ausgefallen sein, die Kommunikation unterbrochen werden, ein Remotedienst reagiert möglicherweise nicht oder befindet sich in einem instabilen Zustand, oder eine Remoteressource ist vielleicht aufgrund von Ressourcenbeschränkungen vorübergehend nicht erreichbar.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-113">For example, the network might be down, communications could be interrupted, a remote service might be unresponsive or in an unstable state, or a remote resource might be temporarily inaccessible, perhaps due to resource constraints.</span></span> <span data-ttu-id="9fdb8-114">In vielen Fällen sind die Fehler vorübergehend und können mithilfe des [Musters „Wiederholung“][retry-pattern] behandelt werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-114">In many cases the failures will be transient and can be handled by using the [Retry pattern][retry-pattern].</span></span>

<span data-ttu-id="9fdb8-115">Wenn die Anwendung einen langfristigeren Fehler feststellt, für den keine einfache Wiederherstellung möglich ist, muss sie in der Lage sein, das System in einen konsistenten Zustand zu versetzen und die Integrität für den gesamten Vorgang zu gewährleisten.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-115">If the application detects a more permanent fault it can't easily recover from, it must be able to restore the system to a consistent state and ensure integrity of the entire operation.</span></span>

## <a name="solution"></a><span data-ttu-id="9fdb8-116">Lösung</span><span class="sxs-lookup"><span data-stu-id="9fdb8-116">Solution</span></span>

<span data-ttu-id="9fdb8-117">Das Muster „Scheduler-Agent-Supervisor“ definiert die folgenden Akteure.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-117">The Scheduler Agent Supervisor pattern defines the following actors.</span></span> <span data-ttu-id="9fdb8-118">Diese Akteure sorgen für eine Orchestrierung der Schritte, die im Rahmen des gesamten Tasks ausgeführt werden müssen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-118">These actors orchestrate the steps to be performed as part of the overall task.</span></span>

- <span data-ttu-id="9fdb8-119">Der **Scheduler** handhabt die Schritte für den auszuführenden Task und orchestriert deren Ausführung.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-119">The **Scheduler** arranges for the steps that make up the task to be executed and orchestrates their operation.</span></span> <span data-ttu-id="9fdb8-120">Diese Schritte können in einer Pipeline oder einem Workflow kombiniert werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-120">These steps can be combined into a pipeline or workflow.</span></span> <span data-ttu-id="9fdb8-121">Der Scheduler muss dafür Sorge tragen, dass die Schritte in diesem Workflow in der richtigen Reihenfolge ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-121">The Scheduler is responsible for ensuring that the steps in this workflow are performed in the right order.</span></span> <span data-ttu-id="9fdb8-122">Während jeder Schritt ausgeführt wird, zeichnet der Scheduler den Zustand des Workflows auf, wie z.B. „Schritt noch nicht gestartet“, „Schritt wird ausgeführt“ oder „Schritt beendet“.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-122">As each step is performed, the Scheduler records the state of the workflow, such as "step not yet started," "step running," or "step completed."</span></span> <span data-ttu-id="9fdb8-123">Die Zustandsinformationen müssen außerdem eine Obergrenze für die Zeit enthalten, die für die Beendigung des Schritts zur Verfügung steht, die so genannte Zeit bis zum Abschluss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-123">The state information should also include an upper limit of the time allowed for the step to finish, called the complete-by time.</span></span> <span data-ttu-id="9fdb8-124">Wenn ein Schritt den Zugriff auf einen Remotedienst oder eine Ressource erfordert, ruft der Scheduler den entsprechenden Agent auf und übergibt ihm die Details der auszuführenden Arbeit.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-124">If a step requires access to a remote service or resource, the Scheduler invokes the appropriate Agent, passing it the details of the work to be performed.</span></span> <span data-ttu-id="9fdb8-125">Der Scheduler kommuniziert typischerweise über asynchrone Anforderungs-/Antwortnachrichten mit dem Agent.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-125">The Scheduler typically communicates with an Agent using asynchronous request/response messaging.</span></span> <span data-ttu-id="9fdb8-126">Diese können mithilfe von Warteschlangen realisiert werden, es können aber auch andere verteilte Messagingtechnologien verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-126">This can be implemented using queues, although other distributed messaging technologies could be used instead.</span></span>

    > <span data-ttu-id="9fdb8-127">Der Scheduler hat eine ähnliche Funktion wie der Prozess-Manager im [Muster „Prozess-Manager“](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-127">The Scheduler performs a similar function to the Process Manager in the [Process Manager pattern](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html).</span></span> <span data-ttu-id="9fdb8-128">Der tatsächliche Workflow wird typischerweise durch ein Workflowmodul definiert und implementiert, das über den Scheduler gesteuert wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-128">The actual workflow is typically defined and implemented by a workflow engine that's controlled by the Scheduler.</span></span> <span data-ttu-id="9fdb8-129">Dieser Ansatz entkoppelt die Geschäftslogik im Workflow vom Scheduler.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-129">This approach decouples the business logic in the workflow from the Scheduler.</span></span>

- <span data-ttu-id="9fdb8-130">Der **Agent** umfasst Logik, die einen Aufruf an einen Remotedienst oder den Zugriff auf eine Remoteressource kapselt, auf die durch einen Schritt in einem Task verwiesen wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-130">The **Agent** contains logic that encapsulates a call to a remote service, or access to a remote resource referenced by a step in a task.</span></span> <span data-ttu-id="9fdb8-131">Jeder Agent umschließt Aufrufe an einen einzelnen Dienst oder eine einzelne Ressource und implementiert die entsprechende Fehlerbehandlung und Wiederholungslogik (abhängig von einer Timeoutbeschränkung, die später beschrieben wird).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-131">Each Agent typically wraps calls to a single service or resource, implementing the appropriate error handling and retry logic (subject to a timeout constraint, described later).</span></span> <span data-ttu-id="9fdb8-132">Wenn die Schritte im Workflow, die vom Scheduler ausgeführt werden, mehrere Dienste und Ressourcen über verschiedene Schritte hinweg verwenden, kann jeder Schritt einen anderen Agent referenzieren (dies ist ein Implementierungsdetail des Musters).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-132">If the steps in the workflow being run by the Scheduler use several services and resources across different steps, each step might reference a different Agent (this is an implementation detail of the pattern).</span></span>

- <span data-ttu-id="9fdb8-133">Der **Supervisor** überwacht den Status der Schritte in dem Task, der vom Scheduler ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-133">The **Supervisor** monitors the status of the steps in the task being performed by the Scheduler.</span></span> <span data-ttu-id="9fdb8-134">Der Supervisor wird in regelmäßigen Abständen (die Häufigkeit ist systemabhängig) ausgeführt und untersucht den Status der Schritte, die vom Scheduler verwaltet werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-134">It runs periodically (the frequency will be system specific), and examines the status of steps maintained by the Scheduler.</span></span> <span data-ttu-id="9fdb8-135">Wenn der Supervisor eine Zeitüberschreitung oder einen Fehler ermittelt, veranlasst er den zuständigen Agent, den Schritt wiederherzustellen oder die geeignete Bereinigungsaktion auszuführen (dies kann eine Änderung des Status für einen Schritt bedeuten).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-135">If it detects any that have timed out or failed, it arranges for the appropriate Agent to recover the step or execute the appropriate remedial action (this might involve modifying the status of a step).</span></span> <span data-ttu-id="9fdb8-136">Beachten Sie, dass die Wiederherstellungs- oder Bereinigungsaktionen vom Scheduler und den Agents implementiert werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-136">Note that the recovery or remedial actions are implemented by the Scheduler and Agents.</span></span> <span data-ttu-id="9fdb8-137">Der Supervisor fordert lediglich an, dass diese Aktionen ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-137">The Supervisor should simply request that these actions be performed.</span></span>

<span data-ttu-id="9fdb8-138">Scheduler, Agent und Supervisor sind logische Komponenten, und ihre physische Implementierung hängt von der verwendeten Technologie ab.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-138">The Scheduler, Agent, and Supervisor are logical components and their physical implementation depends on the technology being used.</span></span> <span data-ttu-id="9fdb8-139">Beispielsweise können mehrere logische Agents als Teil eines einzigen Webdiensts implementiert werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-139">For example, several logical agents might be implemented as part of a single web service.</span></span>

<span data-ttu-id="9fdb8-140">Der Scheduler verwaltet Informationen über den Fortschritt des Tasks und den Zustand jedes einzelnen Schritts in einem dauerhaften Datenspeicher, dem so genannten Zustandsspeicher.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-140">The Scheduler maintains information about the progress of the task and the state of each step in a durable data store, called the state store.</span></span> <span data-ttu-id="9fdb8-141">Anhand dieser Informationen kann der Supervisor feststellen, ob es bei einem Schritt zu einem Fehler gekommen ist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-141">The Supervisor can use this information to help determine whether a step has failed.</span></span> <span data-ttu-id="9fdb8-142">Die Abbildung veranschaulicht die Beziehung zwischen dem Scheduler, den Agents, dem Supervisor und dem Zustandsspeicher.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-142">The figure illustrates the relationship between the Scheduler, the Agents, the Supervisor, and the state store.</span></span>

![Abbildung 1: Die Akteure im Muster „Scheduler-Agent-Supervisor“](./_images/scheduler-agent-supervisor-pattern.png)


> <span data-ttu-id="9fdb8-144">Dieses Diagramm zeigt eine vereinfachte Version des Musters.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-144">This diagram shows a simplified version of the pattern.</span></span> <span data-ttu-id="9fdb8-145">In einer echten Implementierung können viele Instanzen des Schedulers parallel ausgeführt werden, jede als Teilmenge von Tasks.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-145">In a real implementation, there might be many instances of the Scheduler running concurrently, each a subset of tasks.</span></span> <span data-ttu-id="9fdb8-146">Ebenso könnte das System mehrere Instanzen von jedem Agent oder sogar mehrere Supervisors ausführen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-146">Similarly, the system could run multiple instances of each Agent, or even multiple Supervisors.</span></span> <span data-ttu-id="9fdb8-147">In diesem Fall müssen die Supervisors ihre Arbeit sorgfältig aufeinander abstimmen, um sicherzustellen, dass sie nicht dieselben fehlerhaften Schritte und Tasks wiederherstellen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-147">In this case, Supervisors must coordinate their work with each other carefully to ensure that they don’t compete to recover the same failed steps and tasks.</span></span> <span data-ttu-id="9fdb8-148">Das [Muster für die Auswahl einer übergeordneten Instanz](leader-election.md) bietet eine mögliche Lösung für dieses Problem.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-148">The [Leader Election pattern](leader-election.md) provides one possible solution to this problem.</span></span>

<span data-ttu-id="9fdb8-149">Wenn die Anwendung bereit ist, einen Task auszuführen, sendet sie eine Anforderung an den Scheduler.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-149">When the application is ready to run a task, it submits a request to the Scheduler.</span></span> <span data-ttu-id="9fdb8-150">Der Scheduler zeichnet im Zustandsspeicher anfängliche Zustandsinformationen zum Task und den zugehörigen Schritten (z.B. „Schritt noch nicht gestartet“) auf und beginnt dann mit der Ausführung der durch den Workflow definierten Vorgänge.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-150">The Scheduler records initial state information about the task and its steps (for example, step not yet started) in the state store and then starts performing the operations defined by the workflow.</span></span> <span data-ttu-id="9fdb8-151">Wenn der Scheduler einen Schritt startet, aktualisiert er die Informationen über den Zustand dieses Schritts im Zustandsspeicher (z.B. „Schritt wird ausgeführt“).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-151">As the Scheduler starts each step, it updates the information about the state of that step in the state store (for example, step running).</span></span>

<span data-ttu-id="9fdb8-152">Wenn ein Schritt auf einen Remotedienst oder eine Ressource verweist, sendet der Scheduler eine Nachricht an den entsprechenden Agent.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-152">If a step references a remote service or resource, the Scheduler sends a message to the appropriate Agent.</span></span> <span data-ttu-id="9fdb8-153">Die Nachricht enthält die Informationen, die der Agent für die Weiterleitung an den Dienst oder für den Zugriff auf die Ressource benötigt, und umfasst die Zeit bis zum Abschluss für den Vorgang.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-153">The message contains the information that the Agent needs to pass to the service or access the resource, in addition to the complete-by time for the operation.</span></span> <span data-ttu-id="9fdb8-154">Wenn der Agent den Vorgang erfolgreich abgeschlossen hat, gibt er eine Antwort an den Scheduler zurück.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-154">If the Agent completes its operation successfully, it returns a response to the Scheduler.</span></span> <span data-ttu-id="9fdb8-155">Der Scheduler kann anschließend die Zustandsinformationen im Zustandsspeicher aktualisieren (z.B. „Schritt beendet“) und den nächsten Schritt ausführen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-155">The Scheduler can then update the state information in the state store (for example, step completed) and perform the next step.</span></span> <span data-ttu-id="9fdb8-156">Dieser Prozess wird fortgesetzt, bis der gesamte Task abgeschlossen wurde.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-156">This process continues until the entire task is complete.</span></span>

<span data-ttu-id="9fdb8-157">Ein Agent kann eine beliebige Wiederholungslogik implementieren, die für die Ausführung seiner Arbeit notwendig ist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-157">An Agent can implement any retry logic that's necessary to perform its work.</span></span> <span data-ttu-id="9fdb8-158">Wenn der Agent seine Arbeit jedoch nicht vor Ablauf der Zeit bis zum Abschluss beendet, betrachtet der Scheduler den Vorgang als fehlerhaft.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-158">However, if the Agent doesn't complete its work before the complete-by period expires, the Scheduler will assume that the operation has failed.</span></span> <span data-ttu-id="9fdb8-159">In diesem Fall sollte der Agent seine Arbeit einstellen und weder versuchen, Daten an den Scheduler zurückzugeben (nicht einmal eine Fehlermeldung), noch irgendeine Form der Wiederherstellung durchführen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-159">In this case, the Agent should stop its work and not try to return anything to the Scheduler (not even an error message), or try any form of recovery.</span></span> <span data-ttu-id="9fdb8-160">Der Grund für diese Einschränkung liegt darin, dass nach einem Timeout oder Fehler für einen Schritt eine andere Instanz des Agents zur Ausführung des fehlerhaften Schritts geplant sein könnte (dieser Prozess wird später beschrieben).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-160">The reason for this restriction is that, after a step has timed out or failed, another instance of the Agent might be scheduled to run the failing step (this process is described later).</span></span>

<span data-ttu-id="9fdb8-161">Bei einem Fehler des Agents erhält der Scheduler keine Antwort.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-161">If the Agent fails, the Scheduler won't receive a response.</span></span> <span data-ttu-id="9fdb8-162">Das Muster unterscheidet nicht zwischen einem Schritt mit einem Timeout oder einem Schritt mit einem Fehler.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-162">The pattern doesn't make a distinction between a step that has timed out and one that has genuinely failed.</span></span>

<span data-ttu-id="9fdb8-163">Wenn für einen Schritt ein Timeout oder ein Fehler auftritt, weist ein Datensatz im Zustandsspeicher darauf hin, dass der Schritt ausgeführt wird, aber die Zeit bis zum Abschluss abgelaufen ist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-163">If a step times out or fails, the state store will contain a record that indicates that the step is running, but the complete-by time will have passed.</span></span> <span data-ttu-id="9fdb8-164">Der Supervisor sucht nach solchen Schritten und versucht, sie wiederherzustellen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-164">The Supervisor looks for steps like this and tries to recover them.</span></span> <span data-ttu-id="9fdb8-165">Eine mögliche Strategie besteht darin, dass der Supervisor den Wert für die Zeit bis zum Abschluss aktualisiert, um den verfügbaren Zeitraum bis zum Abschluss des Schritts zu verlängern, und dann den Scheduler mithilfe einer Nachricht über den Schritt informiert, für den ein Timeout aufgetreten ist. Der Scheduler kann dann versuchen, diesen Schritt zu wiederholen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-165">One possible strategy is for the Supervisor to update the complete-by value to extend the time available to complete the step, and then send a message to the Scheduler identifying the step that has timed out. The Scheduler can then try to repeat this step.</span></span> <span data-ttu-id="9fdb8-166">Dieser Entwurf erfordert jedoch, dass die Tasks idempotent sind.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-166">However, this design requires the tasks to be idempotent.</span></span>

<span data-ttu-id="9fdb8-167">Der Supervisor muss möglicherweise verhindern, dass ein und derselbe Schritt wiederholt wird, wenn er fortlaufend zu einem Fehler oder einem Timeout führt. Zu diesem Zweck kann der Supervisor im Zustandsspeicher zusätzlich zu den Zustandsinformationen einen Zähler für die Wiederholungsversuche für jeden Schritt verwalten.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-167">The Supervisor might need to prevent the same step from being retried if it continually fails or times out. To do this, the Supervisor could maintain a retry count for each step, along with the state information, in the state store.</span></span> <span data-ttu-id="9fdb8-168">Wenn die Anzahl von Wiederholungsversuchen einen vordefinierten Schwellenwert überschreitet, kann der Supervisor eine bestimmte Zeit abwarten, bevor der Scheduler darüber benachrichtigt wird, dass der Schritt wiederholt werden muss. Hierbei wird die Erwartung zugrunde gelegt, dass der Fehler innerhalb der Wartezeit gelöst wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-168">If this count exceeds a predefined threshold the Supervisor can adopt a strategy of waiting for an extended period before notifying the Scheduler that it should retry the step, in the expectation that the fault will be resolved during this period.</span></span> <span data-ttu-id="9fdb8-169">Alternativ kann der Supervisor eine Nachricht an den Scheduler senden, um den gesamten Task rückgängig zu machen, indem er ein [Muster für eine ausgleichende Transaktion](compensating-transaction.md) implementiert.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-169">Alternatively, the Supervisor can send a message to the Scheduler to request the entire task be undone by implementing a [Compensating Transaction pattern](compensating-transaction.md).</span></span> <span data-ttu-id="9fdb8-170">Dieser Ansatz hängt davon ab, dass der Scheduler und die Agents die notwendigen Informationen zur Verfügung stellen, um die Ausgleichsvorgänge für jeden erfolgreich ausgeführten Schritt zu implementieren.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-170">This approach will depend on the Scheduler and Agents providing the information necessary to implement the compensating operations for each step that completed successfully.</span></span>

> <span data-ttu-id="9fdb8-171">Es ist nicht die Aufgabe des Supervisors, den Scheduler und die Agents zu überwachen und sie bei einem Fehler neu zu starten.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-171">It isn't the purpose of the Supervisor to monitor the Scheduler and Agents, and restart them if they fail.</span></span> <span data-ttu-id="9fdb8-172">Dieser Aspekt des Systems sollte durch die Infrastruktur abgedeckt werden, in der diese Komponenten ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-172">This aspect of the system should be handled by the infrastructure these components are running in.</span></span> <span data-ttu-id="9fdb8-173">Ebenso sollte der Supervisor keine Kenntnis von den tatsächlichen Geschäftsvorgängen haben, die mit den vom Scheduler verarbeiteten Tasks ausgeführt werden (dies schließt auch Informationen zum Ausgleich ein, falls diese Tasks nicht erfolgreich sind).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-173">Similarly, the Supervisor shouldn't have knowledge of the actual business operations that the tasks being performed by the Scheduler are running (including how to compensate should these tasks fail).</span></span> <span data-ttu-id="9fdb8-174">Diese Aufgabe übernimmt die vom Scheduler implementierte Workflowlogik.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-174">This is the purpose of the workflow logic implemented by the Scheduler.</span></span> <span data-ttu-id="9fdb8-175">Die alleinige Verantwortung des Supervisors besteht darin, fehlerhafte Schritte zu ermitteln und dafür zu sorgen, dass nicht erfolgreiche Schritte entweder wiederholt werden oder der gesamte Task rückgängig gemacht wird, der den fehlerhaften Schritt enthält.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-175">The sole responsibility of the Supervisor is to determine whether a step has failed and arrange either for it to be repeated or for the entire task containing the failed step to be undone.</span></span>

<span data-ttu-id="9fdb8-176">Wenn der Scheduler nach einem Fehler neu gestartet oder der vom Scheduler ausgeführte Workflow unerwartet beendet wird, muss der Scheduler in der Lage sein, den Status aller aktiven Tasks zu ermitteln, die er beim Auftreten des Fehlers verarbeitet hat. Außerdem muss er fähig sein, diesen Task von diesem Zeitpunkt an wieder aufzunehmen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-176">If the Scheduler is restarted after a failure, or the workflow being performed by the Scheduler terminates unexpectedly, the Scheduler should be able to determine the status of any inflight task that it was handling when it failed, and be prepared to resume this task from that point.</span></span> <span data-ttu-id="9fdb8-177">Die Implementierungsdetails dieses Prozesses sind wahrscheinlich systemspezifisch.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-177">The implementation details of this process are likely to be system specific.</span></span> <span data-ttu-id="9fdb8-178">Wenn der Task nicht wiederhergestellt werden kann, muss die vom Task bereits ausgeführte Arbeit möglicherweise rückgängig gemacht werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-178">If the task can't be recovered, it might be necessary to undo the work already performed by the task.</span></span> <span data-ttu-id="9fdb8-179">Dies kann auch die Implementierung einer [ausgleichenden Transaktion](compensating-transaction.md) erfordern.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-179">This might also require implementing a [compensating transaction](compensating-transaction.md).</span></span>

<span data-ttu-id="9fdb8-180">Der Hauptvorteil dieses Musters besteht darin, dass das System bei unerwarteten, vorübergehenden oder nicht behebbaren Fehlern stabil bleibt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-180">The key advantage of this pattern is that the system is resilient in the event of unexpected temporary or unrecoverable failures.</span></span> <span data-ttu-id="9fdb8-181">Das System kann für eine Selbstreparatur konzipiert werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-181">The system can be constructed to be self healing.</span></span> <span data-ttu-id="9fdb8-182">Wenn z.B. ein Agent oder der Scheduler ausfällt, kann ein neuer Agent gestartet werden, und der Supervisor kann die Wiederaufnahme eines Tasks veranlassen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-182">For example, if an Agent or the Scheduler fails, a new one can be started and the Supervisor can arrange for a task to be resumed.</span></span> <span data-ttu-id="9fdb8-183">Fällt der Supervisor aus, kann eine weitere Instanz gestartet werden, die an der Stelle übernimmt, an der der Fehler aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-183">If the Supervisor fails, another instance can be started and can take over from where the failure occurred.</span></span> <span data-ttu-id="9fdb8-184">Wenn der Supervisor in regelmäßigen Abständen ausgeführt wird, kann eine neue Instanz nach einem vordefinierten Intervall automatisch gestartet werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-184">If the Supervisor is scheduled to run periodically, a new instance can be automatically started after a predefined interval.</span></span> <span data-ttu-id="9fdb8-185">Der Zustandsspeicher kann repliziert werden, um eine noch höhere Resilienz zu erreichen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-185">The state store can be replicated to reach an even greater degree of resiliency.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="9fdb8-186">Probleme und Überlegungen</span><span class="sxs-lookup"><span data-stu-id="9fdb8-186">Issues and considerations</span></span>

<span data-ttu-id="9fdb8-187">Bei der Entscheidung, wie dieses Muster implementiert werden soll, sind die folgenden Punkte zu beachten:</span><span class="sxs-lookup"><span data-stu-id="9fdb8-187">You should consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="9fdb8-188">Dieses Muster kann schwierig zu implementieren sein und erfordert umfassende Tests aller möglichen Fehlermodi des Systems.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-188">This pattern can be difficult to implement and requires thorough testing of each possible failure mode of the system.</span></span>

- <span data-ttu-id="9fdb8-189">Die vom Scheduler implementierte Wiederherstellungs-/Wiederholungslogik ist komplex und hängt von den Zustandsinformationen im Zustandsspeicher ab.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-189">The recovery/retry logic implemented by the Scheduler is complex and dependent on state information held in the state store.</span></span> <span data-ttu-id="9fdb8-190">Es kann außerdem notwendig sein, die zum Implementieren einer ausgleichenden Transaktion erforderlichen Informationen in einem dauerhaften Datenspeicher aufzuzeichnen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-190">It might also be necessary to record the information required to implement a compensating transaction in a durable data store.</span></span>

- <span data-ttu-id="9fdb8-191">Es ist wichtig, wie häufig der Supervisor ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-191">How often the Supervisor runs will be important.</span></span> <span data-ttu-id="9fdb8-192">Der Supervisor sollte oft genug ausgeführt werden, um zu verhindern, dass nicht erfolgreiche Schritte eine Anwendung für einen längeren Zeitraum blockieren. Gleichzeitig darf die Ausführung nicht zu oft erfolgen, damit es nicht zu einem Overhead kommt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-192">It should run often enough to prevent any failed steps from blocking an application for an extended period, but it shouldn't run so often that it becomes an overhead.</span></span>

- <span data-ttu-id="9fdb8-193">Die von einem Agent verarbeiteten Schritte können mehrmals ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-193">The steps performed by an Agent could be run more than once.</span></span> <span data-ttu-id="9fdb8-194">Die Logik zur Implementierung dieser Schritte sollte idempotent sein.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-194">The logic that implements these steps should be idempotent.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="9fdb8-195">Verwendung dieses Musters</span><span class="sxs-lookup"><span data-stu-id="9fdb8-195">When to use this pattern</span></span>

<span data-ttu-id="9fdb8-196">Verwenden Sie dieses Muster, wenn ein in einer verteilten Umgebung – wie z.B. der Cloud – ausgeführter Prozess gegenüber Kommunikationsfehlern und/oder Betriebsausfällen widerstandsfähig sein muss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-196">Use this pattern when a process that runs in a distributed environment, such as the cloud, must be resilient to communications failure and/or operational failure.</span></span>

<span data-ttu-id="9fdb8-197">Dieses Muster eignet sich möglicherweise nicht für Tasks, die keine Remotedienste aufrufen oder auf Remoteressourcen zugreifen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-197">This pattern might not be suitable for tasks that don't invoke remote services or access remote resources.</span></span>

## <a name="example"></a><span data-ttu-id="9fdb8-198">Beispiel</span><span class="sxs-lookup"><span data-stu-id="9fdb8-198">Example</span></span>

<span data-ttu-id="9fdb8-199">Eine Webanwendung zur Implementierung eines E-Commerce-Systems wurde in Microsoft Azure bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-199">A web application that implements an ecommerce system has been deployed on Microsoft Azure.</span></span> <span data-ttu-id="9fdb8-200">Benutzer können diese Anwendung ausführen, um die verfügbaren Produkte zu durchsuchen und Aufträge zu erteilen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-200">Users can run this application to browse the available products and to place orders.</span></span> <span data-ttu-id="9fdb8-201">Die Benutzeroberfläche wird als Webrolle ausgeführt, und die Anwendungselemente für die Auftragsabwicklung sind als Gruppe von Workerrollen implementiert.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-201">The user interface runs as a web role, and the order processing elements of the application are implemented as a set of worker roles.</span></span> <span data-ttu-id="9fdb8-202">Im Rahmen der Logik für die Auftragsabwicklung wird auf einen Remotedienst zugegriffen, und dieser Aspekt des Systems könnte anfällig für vorübergehende oder länger andauernde Fehler sein.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-202">Part of the order processing logic involves accessing a remote service, and this aspect of the system could be prone to transient or more long-lasting faults.</span></span> <span data-ttu-id="9fdb8-203">Aus diesem Grund haben die Designer zum Implementieren der Systemelemente für die Auftragsabwicklung das Muster „Scheduler-Agent-Supervisor“ verwendet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-203">For this reason, the designers used the Scheduler Agent Supervisor pattern to implement the order processing elements of the system.</span></span>

<span data-ttu-id="9fdb8-204">Wenn ein Kunde einen Auftrag erteilt, erstellt die Anwendung eine Nachricht mit einer Beschreibung des Auftrags und reiht diese Nachricht in eine Warteschlange ein.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-204">When a customer places an order, the application constructs a message that describes the order and posts this message to a queue.</span></span> <span data-ttu-id="9fdb8-205">Ein separater Übermittlungsprozess, der in einer Workerrolle ausgeführt wird, ruft die Nachricht ab, fügt die Auftragsdetails in die Auftragsdatenbank ein und erstellt einen Datensatz für den Auftragsprozess im Zustandsspeicher.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-205">A separate submission process, running in a worker role, retrieves the message, inserts the order details into the orders database, and creates a record for the order process in the state store.</span></span> <span data-ttu-id="9fdb8-206">Beachten Sie, dass das Einfügen in die Auftragsdatenbank und den Zustandsspeicher im Rahmen desselben Vorgangs durchgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-206">Note that the inserts into the orders database and the state store are performed as part of the same operation.</span></span> <span data-ttu-id="9fdb8-207">Der Übermittlungsprozess ist so konzipiert, dass beide Einfügevorgänge gemeinsam abgeschlossen werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-207">The submission process is designed to ensure that both inserts complete together.</span></span>

<span data-ttu-id="9fdb8-208">Der Übermittlungsprozess erstellt die folgenden Zustandsinformationen zum Auftrag:</span><span class="sxs-lookup"><span data-stu-id="9fdb8-208">The state information that the submission process creates for the order includes:</span></span>

- <span data-ttu-id="9fdb8-209">**OrderID**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-209">**OrderID**.</span></span> <span data-ttu-id="9fdb8-210">Die ID des Auftrags in der Auftragsdatenbank.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-210">The ID of the order in the orders database.</span></span>

- <span data-ttu-id="9fdb8-211">**LockedBy**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-211">**LockedBy**.</span></span> <span data-ttu-id="9fdb8-212">Die Instanz-ID der Workerrolle, die den Auftrag verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-212">The instance ID of the worker role handling the order.</span></span> <span data-ttu-id="9fdb8-213">Es kann mehrere aktuelle Instanzen der Workerrolle geben, die den Scheduler ausführen, aber jeder Auftrag sollte nur von einer einzigen Instanz verarbeitet werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-213">There might be multiple current instances of the worker role running the Scheduler, but each order should only be handled by a single instance.</span></span>

- <span data-ttu-id="9fdb8-214">**CompleteBy**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-214">**CompleteBy**.</span></span> <span data-ttu-id="9fdb8-215">Die Zeit, bis zu der der Auftrag verarbeitet werden muss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-215">The time the order should be processed by.</span></span>

- <span data-ttu-id="9fdb8-216">**ProcessState**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-216">**ProcessState**.</span></span> <span data-ttu-id="9fdb8-217">Der aktuelle Zustand des Tasks, der den Auftrag bearbeitet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-217">The current state of the task handling the order.</span></span> <span data-ttu-id="9fdb8-218">Mögliche Zustandswerte:</span><span class="sxs-lookup"><span data-stu-id="9fdb8-218">The possible states are:</span></span>

    - <span data-ttu-id="9fdb8-219">**Pending**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-219">**Pending**.</span></span> <span data-ttu-id="9fdb8-220">Der Auftrag wurde erstellt, aber die Verarbeitung wurde noch nicht gestartet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-220">The order has been created but processing hasn't yet been started.</span></span>
    - <span data-ttu-id="9fdb8-221">**Processing**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-221">**Processing**.</span></span> <span data-ttu-id="9fdb8-222">Der Auftrag wird aktuell verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-222">The order is currently being processed.</span></span>
    - <span data-ttu-id="9fdb8-223">**Processed**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-223">**Processed**.</span></span> <span data-ttu-id="9fdb8-224">Der Auftrag wurde erfolgreich verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-224">The order has been processed successfully.</span></span>
    - <span data-ttu-id="9fdb8-225">**Error**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-225">**Error**.</span></span> <span data-ttu-id="9fdb8-226">Bei der Auftragsverarbeitung ist ein Fehler aufgetreten.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-226">The order processing has failed.</span></span>

- <span data-ttu-id="9fdb8-227">**FailureCount**.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-227">**FailureCount**.</span></span> <span data-ttu-id="9fdb8-228">Gibt an, wie oft versucht wurde, den Auftrag zu verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-228">The number of times that processing has been tried for the order.</span></span>

<span data-ttu-id="9fdb8-229">In diesen Zustandsinformation wird das Feld `OrderID` aus der Auftrags-ID des neuen Auftrags übernommen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-229">In this state information, the `OrderID` field is copied from the order ID of the new order.</span></span> <span data-ttu-id="9fdb8-230">Die Felder `LockedBy` und `CompleteBy` werden auf `null` festgelegt, das Feld `ProcessState` ist auf `Pending`, das Feld `FailureCount` ist auf 0 festgelegt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-230">The `LockedBy` and `CompleteBy` fields are set to `null`, the `ProcessState` field is set to `Pending`, and the `FailureCount` field is set to 0.</span></span>

> <span data-ttu-id="9fdb8-231">In diesem Beispiel ist die Logik der Auftragsabwicklung relativ einfach und besteht nur aus einem einzigen Schritt, der einen Remotedienst aufruft.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-231">In this example, the order handling logic is relatively simple and only has a single step that invokes a remote service.</span></span> <span data-ttu-id="9fdb8-232">In einem komplexeren mehrstufigen Szenario würde der Übermittlungsprozess wahrscheinlich mehrere Schritte umfassen, sodass mehrere Datensätze im Zustandsspeicher erstellt werden – jeder dieser Datensätze beschreibt den Zustand eines einzelnen Schritts.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-232">In a more complex multistep scenario, the submission process would likely involve several steps, and so several records would be created in the state store—each one describing the state of an individual step.</span></span>

<span data-ttu-id="9fdb8-233">Der Scheduler wird ebenfalls als Bestandteil der Workerrolle ausgeführt und implementiert die Geschäftslogik zur Verarbeitung des Auftrags.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-233">The Scheduler also runs as part of a worker role and implements the business logic that handles the order.</span></span> <span data-ttu-id="9fdb8-234">Eine Instanz des Schedulers zum Abrufen neuer Aufträge untersucht den Zustandsspeicher auf Datensätze, bei denen das Feld `LockedBy` NULL ist und das Feld `ProcessState` den Wert „Pending“ aufweist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-234">An instance of the Scheduler polling for new orders examines the state store for records where the `LockedBy` field is null and the `ProcessState` field is pending.</span></span> <span data-ttu-id="9fdb8-235">Wenn der Scheduler einen neuen Auftrag ermittelt, füllt er das Feld `LockedBy` sofort mit seiner eigenen Instanz-ID auf, legt das Feld `CompleteBy` auf eine angemessene Zeit und das Feld `ProcessState` auf „Processing“ fest.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-235">When the Scheduler finds a new order, it immediately populates the `LockedBy` field with its own instance ID, sets the `CompleteBy` field to an appropriate time, and sets the `ProcessState` field to processing.</span></span> <span data-ttu-id="9fdb8-236">Der Code ist als exklusiv und unteilbar konzipiert, um sicherzustellen, dass zwei parallel ausgeführte Instanzen des Schedulers nicht denselben Auftrag verarbeiten können.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-236">The code is designed to be exclusive and atomic to ensure that two concurrent instances of the Scheduler can't try to handle the same order simultaneously.</span></span>

<span data-ttu-id="9fdb8-237">Der Scheduler führt dann den Geschäftsworkflow zur asynchronen Verarbeitung des Auftrags aus und übergibt ihm den Wert im Feld `OrderID` aus dem Zustandsspeicher.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-237">The Scheduler then runs the business workflow to process the order asynchronously, passing it the value in the `OrderID` field from the state store.</span></span> <span data-ttu-id="9fdb8-238">Der Workflow, der den Auftrag bearbeitet, ruft die Details zum Auftrag aus der Auftragsdatenbank ab und führt seine Arbeit aus.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-238">The workflow handling the order retrieves the details of the order from the orders database and performs its work.</span></span> <span data-ttu-id="9fdb8-239">Wenn ein Schritt im Workflow für die Auftragsabwicklung einen Aufruf des Remotediensts erfordert, wird ein Agent verwendet.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-239">When a step in the order processing workflow needs to invoke the remote service, it uses an Agent.</span></span> <span data-ttu-id="9fdb8-240">Der Workflowschritt kommuniziert mit dem Agent über zwei Azure Service Bus-Nachrichtenwarteschlangen, die als Anforderungs-/Antwortkanal fungieren.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-240">The workflow step communicates with the Agent using a pair of Azure Service Bus message queues acting as a request/response channel.</span></span> <span data-ttu-id="9fdb8-241">Die Abbildung zeigt eine allgemeine Ansicht der Lösung.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-241">The figure shows a high level view of the solution.</span></span>

![Abbildung 2: Verwendung des Musters „Scheduler-Agent Supervisor“ zur Auftragsabwicklung in einer Azure-Lösung](./_images/scheduler-agent-supervisor-solution.png)

<span data-ttu-id="9fdb8-243">Die Nachricht, die aus einem Workflowschritt an den Agent gesendet wird, beschreibt den Auftrag und umfasst die Zeit bis zum Abschluss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-243">The message sent to the Agent from a workflow step describes the order and includes the complete-by time.</span></span> <span data-ttu-id="9fdb8-244">Wenn der Agent vor Ablauf der Zeit bis zum Abschluss eine Antwort vom Remotedienst empfängt, sendet er eine Antwortnachricht an die Service Bus-Warteschlange, auf der der Workflow lauscht.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-244">If the Agent receives a response from the remote service before the complete-by time expires, it posts a reply message on the Service Bus queue on which the workflow is listening.</span></span> <span data-ttu-id="9fdb8-245">Wenn der Workflowschritt die gültige Antwortnachricht erhält, schließt er seine Verarbeitung ab, und der Scheduler legt das Feld „ProcessState“ für den Auftragszustand auf „Processed“ fest.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-245">When the workflow step receives the valid reply message, it completes its processing and the Scheduler sets the \`ProcessState field of the order state to processed.</span></span> <span data-ttu-id="9fdb8-246">Zu diesem Zeitpunkt ist die Auftragsabwicklung erfolgreich abgeschlossen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-246">At this point, the order processing has completed successfully.</span></span>

<span data-ttu-id="9fdb8-247">Wenn die Zeit bis zum Abschluss abgelaufen ist, bevor der Agent eine Antwort vom Remotedienst empfangen hat, stoppt der Agent einfach seine Verarbeitung und beendet die Bearbeitung des Auftrags.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-247">If the complete-by time expires before the Agent receives a response from the remote service, the Agent simply halts its processing and terminates handling the order.</span></span> <span data-ttu-id="9fdb8-248">In gleicher Weise beendet der Workflow die Auftragsbearbeitung, wenn die Zeit bis zum Abschluss überschritten wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-248">Similarly, if the workflow handling the order exceeds the complete-by time, it also terminates.</span></span> <span data-ttu-id="9fdb8-249">In beiden Fällen weist der Auftrag im Zustandsspeicher weiterhin den Zustand „Processing“ auf, aber die Zeit bis zum Abschluss zeigt an, dass der Zeitraum für die Auftragsbearbeitung verstrichen ist, und der Prozess wird als fehlerhaft eingestuft.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-249">In both cases, the state of the order in the state store remains set to processing, but the complete-by time indicates that the time for processing the order has passed and the process is deemed to have failed.</span></span> <span data-ttu-id="9fdb8-250">Beachten Sie hierbei Folgendes: Bei einer unerwarteten Beendigung des Agents, der auf den Remotedienst zugreift, oder des Workflows für die Auftragsbearbeitung (oder beides) lautet der Wert im Zustandsspeicher weiterhin „Processing“ und führt schließlich zu einem Ablauf der Zeit bis zum Abschluss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-250">Note that if the Agent that's accessing the remote service, or the workflow that's handling the order (or both) terminate unexpectedly, the information in the state store will again remain set to processing and eventually will have an expired complete-by value.</span></span>

<span data-ttu-id="9fdb8-251">Wenn der Agent beim Versuch der Kontaktaufnahme mit dem Remotedienst einen nicht behebbaren, nicht vorübergehenden Fehler ermittelt, kann er eine Fehlerantwort an den Workflow senden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-251">If the Agent detects an unrecoverable, nontransient fault while it's trying to contact the remote service, it can send an error response back to the workflow.</span></span> <span data-ttu-id="9fdb8-252">Der Scheduler kann den Zustand des Auftrags auf „Error“ festlegen und ein Ereignis auslösen, mit dem ein Operator alarmiert wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-252">The Scheduler can set the status of the order to error and raise an event that alerts an operator.</span></span> <span data-ttu-id="9fdb8-253">Der Operator kann dann versuchen, die Ursache des Fehlers manuell zu beheben und den fehlerhaften Verarbeitungsschritt erneut übermitteln.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-253">The operator can then try to resolve the reason for the failure manually and resubmit the failed processing step.</span></span>

<span data-ttu-id="9fdb8-254">Der Supervisor untersucht den Zustandsspeicher in regelmäßigen Abständen auf Aufträge mit einem abgelaufenen Wert für die Zeit bis zum Abschluss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-254">The Supervisor periodically examines the state store looking for orders with an expired complete-by value.</span></span> <span data-ttu-id="9fdb8-255">Wenn der Supervisor einen solchen Datensatz findet, wird der Wert im Feld `FailureCount` erhöht.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-255">If the Supervisor finds a record, it increments the `FailureCount` field.</span></span> <span data-ttu-id="9fdb8-256">Wenn die Fehleranzahl unter einem bestimmten Schwellenwert liegt, setzt der Supervisor das Feld `LockedBy` auf NULL zurück, aktualisiert das Feld `CompleteBy` mit einer neuen Ablaufzeit und legt das Feld `ProcessState` auf „Pending“ fest.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-256">If the failure count value is below a specified threshold value, the Supervisor resets the `LockedBy` field to null, updates the `CompleteBy` field with a new expiration time, and sets the `ProcessState` field to pending.</span></span> <span data-ttu-id="9fdb8-257">Eine Instanz des Schedulers kann diesen Auftrag auswählen und wie zuvor verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-257">An instance of the Scheduler can pick up this order and perform its processing as before.</span></span> <span data-ttu-id="9fdb8-258">Wenn die Fehleranzahl einen bestimmten Schwellenwert überschreitet, wird davon ausgegangen, dass die Fehlerursache nicht vorübergehend ist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-258">If the failure count value exceeds a specified threshold, the reason for the failure is assumed to be nontransient.</span></span> <span data-ttu-id="9fdb8-259">Der Supervisor legt den Zustand des Auftrags auf „Error“ fest und löst ein Ereignis aus, mit dem ein Operator alarmiert wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-259">The Supervisor sets the status of the order to error and raises an event that alerts an operator.</span></span>

> <span data-ttu-id="9fdb8-260">In diesem Beispiel wird der Supervisor in einer separaten Workerrolle implementiert.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-260">In this example, the Supervisor is implemented in a separate worker role.</span></span> <span data-ttu-id="9fdb8-261">Sie können verschiedene Strategien anwenden, um den Supervisortask auszuführen, beispielsweise können Sie hierzu den Azure Scheduler-Dienst verwenden (nicht zu verwechseln mit der Schedulerkomponente in diesem Muster).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-261">You can use a variety of strategies to arrange for the Supervisor task to be run, including using the Azure Scheduler service (not to be confused with the Scheduler component in this pattern).</span></span> <span data-ttu-id="9fdb8-262">Weitere Informationen zum Azure Scheduler-Dienst finden Sie auf der Seite [Scheduler](https://azure.microsoft.com/services/scheduler/).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-262">For more information about the Azure Scheduler service, visit the [Scheduler](https://azure.microsoft.com/services/scheduler/) page.</span></span>

<span data-ttu-id="9fdb8-263">Im Beispiel wird dies nicht gezeigt, aber es kann erforderlich sein, dass der Scheduler die Anwendung, die den Auftrag übermittelt, über den Fortschritt und Zustand des Auftrags auf dem Laufenden halten muss.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-263">Although it isn't shown in this example, the Scheduler might need to keep the application that submitted the order informed about the progress and status of the order.</span></span> <span data-ttu-id="9fdb8-264">Die Anwendung und der Scheduler sind voneinander isoliert, um Abhängigkeiten zwischen ihnen zu unterbinden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-264">The application and the Scheduler are isolated from each other to eliminate any dependencies between them.</span></span> <span data-ttu-id="9fdb8-265">Die Anwendung hat keine Kenntnis darüber, welche Instanz des Schedulers den Auftrag bearbeitet, und der Scheduler weiß nicht, welche spezifische Anwendungsinstanz den Auftrag gesendet hat.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-265">The application has no knowledge of which instance of the Scheduler is handling the order, and the Scheduler is unaware of which specific application instance posted the order.</span></span>

<span data-ttu-id="9fdb8-266">Um den Auftragsstatus rückmelden zu können, kann die Anwendung beispielsweise eine eigene, private Antwortwarteschlange verwenden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-266">To allow the order status to be reported, the application could use its own private response queue.</span></span> <span data-ttu-id="9fdb8-267">Die Details dieser Antwortwarteschlange würden in die Anforderung an den Übermittlungsprozess eingeschlossen werden, der diese Informationen dann in den Zustandsspeicher aufnimmt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-267">The details of this response queue would be included as part of the request sent to the submission process, which would include this information in the state store.</span></span> <span data-ttu-id="9fdb8-268">Der Scheduler würde anschließend Nachrichten mit dem Auftragsstatus an diese Warteschlange senden („Anforderung eingegangen“, „Auftrag abgeschlossen“, „Auftrag fehlerhaft“ usw.).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-268">The Scheduler would then post messages to this queue indicating the status of the order (request received, order completed, order failed, and so on).</span></span> <span data-ttu-id="9fdb8-269">Diese Nachrichten müssten die Auftrags-ID enthalten, um eine Korrelation mit der ursprünglichen Anforderung durch die Anwendung zu ermöglichen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-269">It should include the order ID in these messages so they can be correlated with the original request by the application.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="9fdb8-270">Zugehörige Muster und Anleitungen</span><span class="sxs-lookup"><span data-stu-id="9fdb8-270">Related patterns and guidance</span></span>

<span data-ttu-id="9fdb8-271">Die folgenden Muster und Anweisungen können für die Implementierung dieses Musters ebenfalls relevant sein:</span><span class="sxs-lookup"><span data-stu-id="9fdb8-271">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="9fdb8-272">[Muster „Wiederholung“][retry-pattern].</span><span class="sxs-lookup"><span data-stu-id="9fdb8-272">[Retry pattern][retry-pattern].</span></span> <span data-ttu-id="9fdb8-273">Ein Agent kann dieses Muster verwenden, um einen Vorgang zum Zugriff auf einen Remotedienst oder eine Remoteressource transparent zu wiederholen, bei dem zuvor ein Fehler aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-273">An Agent can use this pattern to transparently retry an operation that accesses a remote service or resource that has previously failed.</span></span> <span data-ttu-id="9fdb8-274">Verwenden Sie dieses Muster, wenn erwartet wird, dass die Fehlerursache vorübergehend ist und korrigiert werden kann.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-274">Use when the expectation is that the cause of the failure is transient and can be corrected.</span></span>
- <span data-ttu-id="9fdb8-275">[Muster „Trennschalter“](circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-275">[Circuit Breaker pattern](circuit-breaker.md).</span></span> <span data-ttu-id="9fdb8-276">Ein Agent kann mit diesem Muster Fehler behandeln, deren Behebung beim Herstellen einer Verbindung mit einem Remotedienst oder einer Remoteressource unterschiedlich lange dauern kann.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-276">An Agent can use this pattern to handle faults that take a variable amount of time to correct when connecting to a remote service or resource.</span></span>
- <span data-ttu-id="9fdb8-277">[Muster „Ausgleichende Transaktion“](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-277">[Compensating Transaction pattern](compensating-transaction.md).</span></span> <span data-ttu-id="9fdb8-278">Wenn der von einem Scheduler ausgeführte Workflow nicht erfolgreich abgeschlossen werden kann, muss möglicherweise die gesamte zuvor ausgeführte Arbeit rückgängig gemacht werden.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-278">If the workflow being performed by a Scheduler can't be completed successfully, it might be necessary to undo any work it's previously performed.</span></span> <span data-ttu-id="9fdb8-279">Das Muster „Ausgleichende Transaktion“ beschreibt, wie dies für Vorgänge erreicht werden kann, die dem Modell der letztlichen Konsistenz folgen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-279">The Compensating Transaction pattern describes how this can be achieved for operations that follow the eventual consistency model.</span></span> <span data-ttu-id="9fdb8-280">Solche Vorgänge werden üblicherweise von einem Scheduler implementiert, der komplexe Geschäftsprozesse und Workflows ausführt.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-280">These types of operations are commonly implemented by a Scheduler that performs complex business processes and workflows.</span></span>
- <span data-ttu-id="9fdb8-281">[Einführung in asynchrone Nachrichten](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-281">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="9fdb8-282">Die Komponenten im Muster „Scheduler-Agent-Supervisor“ werden typischerweise entkoppelt voneinander ausgeführt und kommunizieren asynchron.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-282">The components in the Scheduler Agent Supervisor pattern typically run decoupled from each other and communicate asynchronously.</span></span> <span data-ttu-id="9fdb8-283">Hier werden einige der Ansätze beschrieben, mit denen eine asynchrone Kommunikation auf der Basis von Nachrichtenwarteschlangen realisiert werden kann.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-283">Describes some of the approaches that can be used to implement asynchronous communication based on message queues.</span></span>
- <span data-ttu-id="9fdb8-284">[Muster für die Auswahl einer übergeordneten Instanz](leader-election.md).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-284">[Leader Election pattern](leader-election.md).</span></span> <span data-ttu-id="9fdb8-285">Die Aktionen mehrerer Instanzen eines Supervisors müssen ggf. koordiniert werden, damit nicht versucht wird, dieselben fehlerhaften Prozesse wiederherzustellen.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-285">It might be necessary to coordinate the actions of multiple instances of a Supervisor to prevent them from attempting to recover the same failed process.</span></span> <span data-ttu-id="9fdb8-286">Das Muster für die Auswahl einer übergeordneten Instanz beschreibt, wie dies erreicht wird.</span><span class="sxs-lookup"><span data-stu-id="9fdb8-286">The Leader Election pattern describes how to do this.</span></span>
- <span data-ttu-id="9fdb8-287">[Cloud Architecture: The Scheduler-Agent-Supervisor Pattern](https://blogs.msdn.microsoft.com/clemensv/2010/09/27/cloud-architecture-the-scheduler-agent-supervisor-pattern/) (Cloudarchitektur: Das Scheduler-Agent-Supervisor-Muster) im Blog von Clements Vasters</span><span class="sxs-lookup"><span data-stu-id="9fdb8-287">[Cloud Architecture: The Scheduler-Agent-Supervisor Pattern](https://blogs.msdn.microsoft.com/clemensv/2010/09/27/cloud-architecture-the-scheduler-agent-supervisor-pattern/) on Clemens Vasters' blog</span></span>
- [<span data-ttu-id="9fdb8-288">Muster „Prozess-Manager“</span><span class="sxs-lookup"><span data-stu-id="9fdb8-288">Process Manager pattern</span></span>](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html)
- <span data-ttu-id="9fdb8-289">[Reference 6: A Saga on Sagas](https://msdn.microsoft.com/library/jj591569.aspx) (Referenz 6: Eine Saga zur Saga).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-289">[Reference 6: A Saga on Sagas](https://msdn.microsoft.com/library/jj591569.aspx).</span></span> <span data-ttu-id="9fdb8-290">In diesem Beispiel wird gezeigt, wie das CQRS-Muster einen Prozess-Manager verwendet (Teil des CQRS Journey-Leitfadens).</span><span class="sxs-lookup"><span data-stu-id="9fdb8-290">An example showing how the CQRS pattern uses a process manager (part of the CQRS Journey guidance).</span></span>
- [<span data-ttu-id="9fdb8-291">Microsoft Azure Scheduler</span><span class="sxs-lookup"><span data-stu-id="9fdb8-291">Microsoft Azure Scheduler</span></span>](https://azure.microsoft.com/services/scheduler/)

[retry-pattern]: ./retry.md
